/* eslint-env mocha */
const debug = require('debug')('liquality:agent:test')
const chai = require('chai')
const chaiHttp = require('chai-http')
chai.should()
chai.use(chaiHttp)
const BN = require('bignumber.js')

const { expect } = chai

const { v4: uuidv4 } = require('uuid')
const mongoose = require('mongoose')
const { sha256 } = require('@chainify/utils')

const api = require('../../src/api')
const worker = require('../../src/worker')
const config = require('../../src/config')

const Asset = require('../../src/models/Asset')
const Market = require('../../src/models/Market')
const MarketHistory = require('../../src/models/MarketHistory')
const Order = require('../../src/models/Order')
const Check = require('../../src/models/Check')

const { assets: cryptoassets } = require('../../src/utils/cryptoassets')
const assets = require('../../src/migrate/data/assets.json')
const markets = require('../../src/migrate/data/markets.json')

const blockScanOrFind = require('../../src/utils/blockScanOrFind')
const { wait, waitForRandom, withLock } = require('../../src/utils/chainLock')

const btcPreset = require('../client-presets/btc')
const ethPreset = require('../client-presets/eth')
const { getChainifyAsset, approve, HTLC_ADDRESS } = require('../../src/utils/chainify')

const presets = {
  BTC: btcPreset,
  ETH: ethPreset,
  DAI: ethPreset
}

const getClient = async function (asset) {
  const preset = presets[asset]
  return preset(config.assets[asset])
}

module.exports.getClient = getClient

const updateMarketData = () => Market.updateAllMarketData().then(() => debug('Updated marketdata'))

module.exports.updateMarketData = updateMarketData

const clear = () =>
  Order.deleteMany({})
    .then(() => debug('Cleared Order collection'))
    .then(() => Check.deleteMany({}))
    .then(() => debug('Cleared Check collection'))
    .then(() => Asset.deleteMany({}))
    .then(() => Asset.insertMany(assets, { ordered: false }))
    .then(() => debug('Reinstalled Asset collection'))
    .then(() => Market.deleteMany({}))
    .then(() =>
      Market.insertMany(
        markets.filter(
          (market) => ['BTC', 'ETH', 'DAI'].includes(market.from) && ['BTC', 'ETH', 'DAI'].includes(market.to)
        ),
        { ordered: false }
      )
    )
    .then(() => debug('Reinstalled Market collection'))
    .then(() => MarketHistory.deleteMany({}))
    .then(() => debug('Cleared MarketHistory collection'))
    .then(updateMarketData)

module.exports.prepare = () =>
  mongoose
    .connect(config.database.uri, { useNewUrlParser: true })
    .then(() => module.exports.deployAndMintMidman())
    .then(() => module.exports.deployHtlc())
    .then(() => clear())
    .then(() => worker.start())
    .then(() => api.start())
    .then(() => waitForRandom(3500, 5000))
    .then(() => debug('Started api & worker'))

module.exports.requestQuote = async (context, request) => {
  return request
    .post('/api/swap/order')
    .send({
      from: context.from,
      to: context.to,
      fromAmount: context.fromAmount
    })
    .then((res) => {
      res.should.have.status(200)
      res.body.should.be.a('object')

      res.body.from.should.equal(context.from)
      res.body.to.should.equal(context.to)

      res.body.swapExpiration.should.be.a('number')
      res.body.nodeSwapExpiration.should.be.a('number')

      res.body.status.should.equal('QUOTE')

      Object.assign(context, res.body)
    })
}

module.exports.testQuote = async (context, request) => {
  return request.get(`/api/swap/order/${context.orderId}`).then((res) => {
    res.should.have.status(200)
    res.body.should.be.a('object')

    res.body.orderId.should.equal(context.orderId)

    res.body.from.should.equal(context.from)
    res.body.to.should.equal(context.to)

    res.body.fromAmount.should.equal(context.fromAmount)

    res.body.swapExpiration.should.equal(context.swapExpiration)
    res.body.nodeSwapExpiration.should.equal(context.nodeSwapExpiration)

    res.body.status.should.equal('QUOTE')
  })
}

module.exports.approveOrder = async (context) => {
  const check = await Check.getCheckForOrder(context.orderId)

  const now = new Date()

  check.set('flags.reciprocate-init-swap', {
    approve: now,
    message: 'test'
  })

  return check.save()
}

module.exports.userInitiate = async (context, request) => {
  const fromClient = await getClient(context.from)
  const toClient = await getClient(context.to)

  context.fromAddress = (await fromClient.wallet.getUnusedAddress()).toString()
  context.toAddress = (await toClient.wallet.getUnusedAddress()).toString()
  context.secret = await fromClient.swap.generateSecret(uuidv4())
  context.secretHash = sha256(context.secret)
  context.toBlock = await toClient.chain.getBlockHeight()

  const { defaultFee } = config.assets[context.from]
  const asset = getChainifyAsset(cryptoassets[context.from])

  const tx = await withLock(context.from, async () => {
    const fees = await fromClient.chain.getFees()

    return fromClient.swap.initiateSwap(
      {
        asset,
        value: BN(context.fromAmount),
        recipientAddress: context.fromCounterPartyAddress,
        refundAddress: context.fromAddress,
        secretHash: context.secretHash,
        expiration: context.swapExpiration
      },
      fees[defaultFee].fee
    )
  })

  context.fromFundHash = tx.hash
  return module.exports.updateAgentOrder(context, request)
}

module.exports.userApprove = async (context) => {
  const fromClient = await getClient(context.from)
  const fromAsset = config.assets[context.from]

  // approve is needed only for ERC20 tokens
  if (!fromAsset.contractAddress) {
    return null
  }

  const tx = await withLock(context.from, async () => {
    const fees = await fromClient.chain.getFees()
    return approve(fromClient, context.from, fees[fromAsset.defaultFee].fee)
  })

  if (tx) {
    context.fromSecondaryFundHash = tx.hash
  }
}

module.exports.updateAgentOrder = (context, request, isDuplicate = false) => {
  return request
    .post(`/api/swap/order/${context.orderId}`)
    .send({
      fromAddress: context.fromAddress,
      toAddress: context.toAddress,
      fromFundHash: context.fromFundHash,
      secretHash: context.secretHash,
      swapExpiration: context.swapExpiration,
      nodeSwapExpiration: context.nodeSwapExpiration
    })
    .then((res) => {
      if (isDuplicate) {
        res.should.have.status(400)
        res.body.error.should.equal(`Duplicate order: ${context.orderId}`)
      } else {
        res.should.have.status(200)
        res.body.should.be.a('object')

        res.body.orderId.should.equal(context.orderId)
        res.body.from.should.equal(context.from)
        res.body.to.should.equal(context.to)
        res.body.fromAmount.should.equal(context.fromAmount)
        res.body.status.should.equal('USER_FUNDED_UNVERIFIED')

        Object.assign(context, res.body)
      }
    })
}

module.exports.verifyAgentInitiation = async (context, request) => {
  const check = () =>
    waitForRandom(1000, 1500).then(() =>
      request.get(`/api/swap/order/${context.orderId}`).then((res) => {
        res.should.have.status(200)

        if (res.body.status === 'USER_FUNDED_UNVERIFIED') {
          return check()
        }

        // if agent funds immediately, status will be AGENT_APPROVED instead of USER_FUNDED
        res.body.status.should.be.oneOf(['USER_FUNDED', 'AGENT_APPROVED'])
      })
    )

  return check()
}

module.exports.verifyAgentFunding = async (context, request) => {
  const check = () =>
    waitForRandom(1000, 1500).then(() =>
      request.get(`/api/swap/order/${context.orderId}`).then((res) => {
        res.should.have.status(200)

        if (['USER_FUNDED', 'AGENT_CONTRACT_CREATED'].includes(res.body.status)) {
          return check()
        }

        res.body.status.should.equal('AGENT_APPROVED')
      })
    )

  return check()
}

module.exports.findAgentFundingTx = async (context) => {
  const toClient = await getClient(context.to)
  const asset = getChainifyAsset(cryptoassets[context.to])

  const findInitSwapTx = async (lastScannedBlock) => {
    const currentBlock = await toClient.chain.getBlockHeight()
    const initSwapTx = await blockScanOrFind(
      toClient,
      async (blockNumber) =>
        toClient.swap.findInitiateSwapTransaction(
          {
            asset,
            value: BN(context.toAmount),
            recipientAddress: context.toAddress,
            refundAddress: context.toCounterPartyAddress,
            secretHash: context.secretHash,
            expiration: context.nodeSwapExpiration
          },
          blockNumber
        ),
      lastScannedBlock,
      currentBlock
    )

    if (initSwapTx) return initSwapTx

    return waitForRandom(1000, 1500).then(() => findInitSwapTx(currentBlock))
  }

  const tx = await findInitSwapTx(context.toBlock)
  context.toFundHash = tx.hash
}

module.exports.userClaim = async (context) => {
  const toClient = await getClient(context.to)

  const { defaultFee } = config.assets[context.to]
  const asset = getChainifyAsset(cryptoassets[context.to])

  return withLock(context.to, async () => {
    const fees = await toClient.chain.getFees()

    return toClient.swap.claimSwap(
      {
        asset: asset,
        value: BN(context.toAmount),
        recipientAddress: context.toAddress,
        refundAddress: context.toCounterPartyAddress,
        secretHash: context.secretHash,
        expiration: context.nodeSwapExpiration
      },
      context.toFundHash,
      context.secret,
      fees[defaultFee].fee
    )
  })
}

module.exports.verifyUserRefund = async (context, request) => {
  const check = () =>
    waitForRandom(1000, 1500).then(() =>
      request.get(`/api/swap/order/${context.orderId}`).then((res) => {
        res.should.have.status(200)

        if (!res.body.fromRefundHash) return check()

        expect(res.body.fromRefundHash).to.equal(context.fromRefundHash)
      })
    )

  return check()
}

module.exports.verifyAllTxs = async (context, request) => {
  const check = () =>
    waitForRandom(1000, 1500).then(() =>
      request.get(`/api/swap/order/${context.orderId}`).then((res) => {
        res.should.have.status(200)

        if (res.body.hasAgentUnconfirmedTx) {
          return check()
        }

        expect(res.body.hasAgentUnconfirmedTx).to.equal(false)
      })
    )

  return check()
}

module.exports.verifyAgentClaimOrRefund = async (context, request, expectedStatus) => {
  const check = () =>
    waitForRandom(1000, 1500).then(() =>
      request.get(`/api/swap/order/${context.orderId}`).then((res) => {
        res.should.have.status(200)

        if (['AGENT_FUNDED', 'USER_CLAIMED'].includes(res.body.status)) {
          return check()
        }

        res.body.status.should.equal(expectedStatus)
      })
    )

  return check()
}

module.exports.deployAndMintMidman = async () => {
  const eth = await getClient('ETH')

  const code = await eth.chain.getProvider().getCode(config.assets.DAI.contractAddress, 'latest')
  if (code !== '0x') {
    return debug('MIDMAN ERC-20 contract already exists')
  }

  debug('Deploying MIDMAN ERC-20 contract')

  const tx = await eth.wallet.sendTransaction({
    to: null,
    value: 0,
    data: '0x60c0604052600660808190526526a4a226a0a760d11b60a09081526100279160039190610072565b506040805180820190915260038082526213525160ea1b602090920191825261005291600491610072565b506005805460ff1916601217905534801561006c57600080fd5b5061010d565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f106100b357805160ff19168380011785556100e0565b828001600101855582156100e0579182015b828111156100e05782518255916020019190600101906100c5565b506100ec9291506100f0565b5090565b61010a91905b808211156100ec57600081556001016100f6565b90565b610b538061011c6000396000f3fe608060405234801561001057600080fd5b50600436106100b45760003560e01c806340c10f191161007157806340c10f191461021057806370a082311461023e57806395d89b4114610264578063a457c2d71461026c578063a9059cbb14610298578063dd62ed3e146102c4576100b4565b806306fdde03146100b9578063095ea7b31461013657806318160ddd1461017657806323b872dd14610190578063313ce567146101c657806339509351146101e4575b600080fd5b6100c16102f2565b6040805160208082528351818301528351919283929083019185019080838360005b838110156100fb5781810151838201526020016100e3565b50505050905090810190601f1680156101285780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b6101626004803603604081101561014c57600080fd5b506001600160a01b038135169060200135610388565b604080519115158252519081900360200190f35b61017e6103a5565b60408051918252519081900360200190f35b610162600480360360608110156101a657600080fd5b506001600160a01b038135811691602081013590911690604001356103ab565b6101ce610438565b6040805160ff9092168252519081900360200190f35b610162600480360360408110156101fa57600080fd5b506001600160a01b038135169060200135610441565b61023c6004803603604081101561022657600080fd5b506001600160a01b038135169060200135610495565b005b61017e6004803603602081101561025457600080fd5b50356001600160a01b03166104a3565b6100c16104be565b6101626004803603604081101561028257600080fd5b506001600160a01b03813516906020013561051f565b610162600480360360408110156102ae57600080fd5b506001600160a01b03813516906020013561058d565b61017e600480360360408110156102da57600080fd5b506001600160a01b03813581169160200135166105a1565b60038054604080516020601f600260001961010060018816150201909516949094049384018190048102820181019092528281526060939092909183018282801561037e5780601f106103535761010080835404028352916020019161037e565b820191906000526020600020905b81548152906001019060200180831161036157829003601f168201915b5050505050905090565b600061039c6103956105cc565b84846105d0565b50600192915050565b60025490565b60006103b88484846106bc565b61042e846103c46105cc565b61042985604051806060016040528060288152602001610a88602891396001600160a01b038a166000908152600160205260408120906104026105cc565b6001600160a01b03168152602081019190915260400160002054919063ffffffff61082316565b6105d0565b5060019392505050565b60055460ff1690565b600061039c61044e6105cc565b84610429856001600061045f6105cc565b6001600160a01b03908116825260208083019390935260409182016000908120918c16815292529020549063ffffffff6108ba16565b61049f828261091b565b5050565b6001600160a01b031660009081526020819052604090205490565b60048054604080516020601f600260001961010060018816150201909516949094049384018190048102820181019092528281526060939092909183018282801561037e5780601f106103535761010080835404028352916020019161037e565b600061039c61052c6105cc565b8461042985604051806060016040528060258152602001610af960259139600160006105566105cc565b6001600160a01b03908116825260208083019390935260409182016000908120918d1681529252902054919063ffffffff61082316565b600061039c61059a6105cc565b84846106bc565b6001600160a01b03918216600090815260016020908152604080832093909416825291909152205490565b3390565b6001600160a01b0383166106155760405162461bcd60e51b8152600401808060200182810382526024815260200180610ad56024913960400191505060405180910390fd5b6001600160a01b03821661065a5760405162461bcd60e51b8152600401808060200182810382526022815260200180610a406022913960400191505060405180910390fd5b6001600160a01b03808416600081815260016020908152604080832094871680845294825291829020859055815185815291517f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b9259281900390910190a3505050565b6001600160a01b0383166107015760405162461bcd60e51b8152600401808060200182810382526025815260200180610ab06025913960400191505060405180910390fd5b6001600160a01b0382166107465760405162461bcd60e51b8152600401808060200182810382526023815260200180610a1d6023913960400191505060405180910390fd5b610751838383610a17565b61079481604051806060016040528060268152602001610a62602691396001600160a01b038616600090815260208190526040902054919063ffffffff61082316565b6001600160a01b0380851660009081526020819052604080822093909355908416815220546107c9908263ffffffff6108ba16565b6001600160a01b038084166000818152602081815260409182902094909455805185815290519193928716927fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef92918290030190a3505050565b600081848411156108b25760405162461bcd60e51b81526004018080602001828103825283818151815260200191508051906020019080838360005b8381101561087757818101518382015260200161085f565b50505050905090810190601f1680156108a45780820380516001836020036101000a031916815260200191505b509250505060405180910390fd5b505050900390565b600082820183811015610914576040805162461bcd60e51b815260206004820152601b60248201527f536166654d6174683a206164646974696f6e206f766572666c6f770000000000604482015290519081900360640190fd5b9392505050565b6001600160a01b038216610976576040805162461bcd60e51b815260206004820152601f60248201527f45524332303a206d696e7420746f20746865207a65726f206164647265737300604482015290519081900360640190fd5b61098260008383610a17565b600254610995908263ffffffff6108ba16565b6002556001600160a01b0382166000908152602081905260409020546109c1908263ffffffff6108ba16565b6001600160a01b0383166000818152602081815260408083209490945583518581529351929391927fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef9281900390910190a35050565b50505056fe45524332303a207472616e7366657220746f20746865207a65726f206164647265737345524332303a20617070726f766520746f20746865207a65726f206164647265737345524332303a207472616e7366657220616d6f756e7420657863656564732062616c616e636545524332303a207472616e7366657220616d6f756e74206578636565647320616c6c6f77616e636545524332303a207472616e736665722066726f6d20746865207a65726f206164647265737345524332303a20617070726f76652066726f6d20746865207a65726f206164647265737345524332303a2064656372656173656420616c6c6f77616e63652062656c6f77207a65726fa26469706673582212209d04412a8766e6bfa22667b8c1457c767c4d231c93e3ebef7a054db806407a5164736f6c63430006000033'
  })

  let txReceipt = null

  while (txReceipt === null) {
    txReceipt = await eth.chain.getProvider().getTransactionReceipt(tx.hash)
    await wait(5000)
  }

  debug('MIDMAN Contract Address', txReceipt.contractAddress)

  if (config.assets.DAI.contractAddress !== txReceipt.contractAddress) {
    throw new Error(`Deployed contract address doesn't match ${config.assets.DAI.contractAddress}`)
  }

  debug('Minting 1,000,000,000 MID tokens for agent')

  const mintAgentTx = await eth.wallet.sendTransaction({
    to: txReceipt.contractAddress,
    value: null,
    data: '0x40c10f19000000000000000000000000625ACaEdeF812d2842eFd2Fb0294682A868455bd0000000000000000000000000000000000000000033b2e3c9fd0803ce8000000'
  })

  debug('MIDMAN minting for agent tx hash', mintAgentTx.hash)

  debug('Minting 1,000,000,000 MID tokens for wallet')

  const mintWalletTx = await eth.wallet.sendTransaction({
    to: txReceipt.contractAddress,
    value: null,
    data: '0x40c10f190000000000000000000000003dc584c132f6189dca45152ea889b9aac70db0c30000000000000000000000000000000000000000033b2e3c9fd0803ce8000000'
  })

  debug('MIDMAN minting for wallet tx hash', mintWalletTx.hash)
}

module.exports.deployHtlc = async () => {
  const eth = await getClient('ETH')

  const code = await eth.chain.getProvider().getCode('0x' + HTLC_ADDRESS, 'latest')
  if (code !== '0x') {
    return debug('HTLC contract already exists')
  }

  debug('Deploying HTLC')

  const tx = await eth.wallet.sendTransaction({
    to: null,
    value: 0,
    data: '0x608060405234801561001057600080fd5b50610cfd806100206000396000f3fe60806040526004361061003f5760003560e01c8063337bc2fa146100445780637249fbb61461006a57806384cc9dfb1461008c57806391edd8f2146100ac575b600080fd5b610057610052366004610a95565b610147565b6040519081526020015b60405180910390f35b34801561007657600080fd5b5061008a610085366004610aad565b61036d565b005b34801561009857600080fd5b5061008a6100a7366004610ac6565b6104c8565b3480156100b857600080fd5b5061010b6100c7366004610aad565b6000602081905290815260409020805460018201546002830154600384015460048501546005909501549394929391926001600160a01b0391821692908216911686565b604080519687526020870195909552938501929092526001600160a01b03908116606085015290811660808401521660a082015260c001610061565b6000428260200135101561016e5760405163e7ec8bc960e01b815260040160405180910390fd5b813561018d57604051639f7fe22f60e01b815260040160405180910390fd5b600061019f6080840160608501610b00565b6001600160a01b031614156101d457813534146101cf576040516309a9fccd60e01b815260040160405180910390fd5b61021b565b34156101f3576040516309a9fccd60e01b815260040160405180910390fd5b61021b3330843561020a6080870160608801610b00565b6001600160a01b03169291906106a0565b600261022d60a0840160808501610b00565b4284356020860135604087013561024a60c0890160a08a01610b00565b604080516001600160a01b039788166020820152908101959095526060850193909352608084019190915260a083015290911660c082015260e00160408051601f198184030181529082905261029f91610b49565b602060405180830381855afa1580156102bc573d6000803e3d6000fd5b5050506040513d601f19601f820116820180604052508101906102df9190610b65565b600081815260208190526040902060010154909150156103125760405163908b86b760e01b815260040160405180910390fd5b6000818152602081905260409020829061032c8282610b7e565b9050507f3c07675a13dc2c3d44c781f9dd3db9ac3a9cc543a5f46777f7bd60a942cf6eb78183604051610360929190610c1e565b60405180910390a1919050565b60008181526020818152604091829020825160c08101845281548152600182015492810183905260028201549381019390935260038101546001600160a01b0390811660608501526004820154811660808501526005909101541660a08301526103ea5760405163501a3cef60e11b815260040160405180910390fd5b8060200151421161040e576040516377128aa160e11b815260040160405180910390fd5b60008281526020819052604080822082815560018101839055600281018390556003810180546001600160a01b0319908116909155600482018054821690556005909101805490911690555183917f3fbd469ec3a5ce074f975f76ce27e727ba21c99176917b97ae2e713695582a1291a260608101516001600160a01b03166104a7576104a38160800151826000015161073e565b5050565b6080810151815160608301516104a3926001600160a01b03909116916107e6565b60008281526020818152604091829020825160c08101845281548152600182015492810183905260028201549381019390935260038101546001600160a01b0390811660608501526004820154811660808501526005909101541660a08301526105455760405163501a3cef60e11b815260040160405180910390fd5b806040015160028360405160200161055f91815260200190565b60408051601f198184030181529082905261057991610b49565b602060405180830381855afa158015610596573d6000803e3d6000fd5b5050506040513d601f19601f820116820180604052508101906105b99190610b65565b146105d7576040516392631d5760e01b815260040160405180910390fd5b6000838152602081815260408083208381556001810184905560028101939093556003830180546001600160a01b03199081169091556004840180548216905560059093018054909316909255905183815284917f5664142af3dcfc3dc3de45a43f75c746bd1d8c11170a5037fdf98bdb35775137910160405180910390a260608101516001600160a01b031661067f5761067a8160a00151826000015161073e565b505050565b60a08101518151606083015161067a926001600160a01b03909116916107e6565b6040516001600160a01b03808516602483015283166044820152606481018290526107389085906323b872dd60e01b906084015b60408051601f198184030181529190526020810180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff167fffffffff0000000000000000000000000000000000000000000000000000000090931692909217909152610816565b50505050565b6000826001600160a01b03168260405160006040518083038185875af1925050503d806000811461078b576040519150601f19603f3d011682016040523d82523d6000602084013e610790565b606091505b505090508061067a5760405162461bcd60e51b815260206004820152600f60248201527f7472616e73666572206661696c6564000000000000000000000000000000000060448201526064015b60405180910390fd5b6040516001600160a01b03831660248201526044810182905261067a90849063a9059cbb60e01b906064016106d4565b600061086b826040518060400160405280602081526020017f5361666545524332303a206c6f772d6c6576656c2063616c6c206661696c6564815250856001600160a01b03166108fb9092919063ffffffff16565b80519091501561067a57808060200190518101906108899190610c9b565b61067a5760405162461bcd60e51b815260206004820152602a60248201527f5361666545524332303a204552433230206f7065726174696f6e20646964206e60448201527f6f7420737563636565640000000000000000000000000000000000000000000060648201526084016107dd565b606061090a8484600085610914565b90505b9392505050565b60608247101561098c5760405162461bcd60e51b815260206004820152602660248201527f416464726573733a20696e73756666696369656e742062616c616e636520666f60448201527f722063616c6c000000000000000000000000000000000000000000000000000060648201526084016107dd565b6001600160a01b0385163b6109e35760405162461bcd60e51b815260206004820152601d60248201527f416464726573733a2063616c6c20746f206e6f6e2d636f6e747261637400000060448201526064016107dd565b600080866001600160a01b031685876040516109ff9190610b49565b60006040518083038185875af1925050503d8060008114610a3c576040519150601f19603f3d011682016040523d82523d6000602084013e610a41565b606091505b5091509150610a51828286610a5c565b979650505050505050565b60608315610a6b57508161090d565b825115610a7b5782518084602001fd5b8160405162461bcd60e51b81526004016107dd9190610cbd565b600060c08284031215610aa757600080fd5b50919050565b600060208284031215610abf57600080fd5b5035919050565b60008060408385031215610ad957600080fd5b50508035926020909101359150565b6001600160a01b0381168114610afd57600080fd5b50565b600060208284031215610b1257600080fd5b813561090d81610ae8565b60005b83811015610b38578181015183820152602001610b20565b838111156107385750506000910152565b60008251610b5b818460208701610b1d565b9190910192915050565b600060208284031215610b7757600080fd5b5051919050565b8135815560208201356001820155604082013560028201556060820135610ba481610ae8565b6003820180546001600160a01b0319166001600160a01b038316179055506080820135610bd081610ae8565b6004820180546001600160a01b0319166001600160a01b0383161790555060a0820135610bfc81610ae8565b6005820180546001600160a01b0319166001600160a01b038316179055505050565b600060e0820190508382528235602083015260208301356040830152604083013560608301526060830135610c5281610ae8565b6001600160a01b03808216608085015260808501359150610c7282610ae8565b80821660a085015260a08501359150610c8a82610ae8565b80821660c085015250509392505050565b600060208284031215610cad57600080fd5b8151801515811461090d57600080fd5b6020815260008251806020840152610cdc816040850160208701610b1d565b601f01601f1916919091016040019291505056fea164736f6c634300080b000a'
  })

  let txReceipt = null

  while (txReceipt === null) {
    txReceipt = await eth.chain.getProvider().getTransactionReceipt(tx.hash)
    await wait(5000)
  }

  debug('HTLC Contract Address', txReceipt.contractAddress)

  if ('0x' + HTLC_ADDRESS !== txReceipt.contractAddress) {
    throw new Error(`Deployed contract address doesn't match ${HTLC_ADDRESS}`)
  }
}
